<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texture2d Splitter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border: none;
        }
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            min-height: 120px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7 0%, #3498db 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5d4ae0 0%, #2980b9 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border: none;
        }
        .feature-icon {
            font-size: 1.2rem;
            margin-right: 5px;
            color: #6c5ce7;
        }
        .drop-zone {
            border: 2px dashed #6c5ce7;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            background-color: rgba(108, 92, 231, 0.05);
            transition: all 0.3s;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .drop-zone.drag-over {
            background-color: rgba(108, 92, 231, 0.2);
            border-color: #3498db;
        }
        .status-bar {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 15px;
        }
        .info-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Results View Styles */
        #results-view {
            display: none;
            min-height: 100vh;
        }
        
        .results-header {
            background: linear-gradient(135deg, #6c5ce7 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .search-box {
            position: sticky;
            top: 20px;
            z-index: 100;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .sprite-list-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .sprite-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sprite-list-item:hover {
            border-color: #6c5ce7;
            background-color: #f8f9ff;
            transform: translateX(5px);
        }
        
        .sprite-list-item.active {
            border-color: #6c5ce7;
            background-color: #f0f5ff;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.2);
        }
        
        .sprite-list-item.hidden {
            display: none;
        }
        
        .sprite-list-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px;
            background: white;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .sprite-list-info {
            flex-grow: 1;
            min-width: 0;
        }
        
        .sprite-list-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sprite-list-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .results-preview-container {
            position: sticky;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 450px;
            position: relative;
        }
        
        .results-preview-image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            min-height: 450px;
            border: 2px dashed #dee2e6;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }
        
        .results-preview-image-container.grabbing {
            cursor: grabbing;
        }
        
        .results-preview-image {
            max-width: 400px;
            max-height: 400px;
            object-fit: contain;
            transition: transform 0.1s ease-out;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: #6c5ce7;
        }
        
        .zoom-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .zoom-level {
            width: 60px;
            height: 36px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .results-preview-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .no-results-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Info Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel"><i class="fas fa-info-circle"></i> How to Use This Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ol>
                        <li>Add your <strong>MonoBehaviour JSON files</strong> (from Unity sprite atlases)</li>
                        <li>Add the corresponding <strong>texture files</strong> (PNG, JPG, etc.)</li>
                        <li>Click <strong>Process Atlas</strong> to extract sprites</li>
                        <li>Use the search box to filter sprites by name</li>
                        <li>Select sprites to download and click <strong>Download Selected</strong></li>
                        <li>Use <strong>Select All</strong> or <strong>Deselect All</strong> to manage selections</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Upload/Processing View -->
    <div class="container" id="main-view">
        <div class="row justify-content-center">
            <div class="col-lg-10 mb-3">
                <a href="../Sprite-Assembly/Sprite Compiler/index.html" class="btn btn-outline-info">
                    <i class="fas fa-box-arrow-right"></i> Go to Sprite Compiler
                </a>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-code feature-icon"></i> MonoBehaviour JSON Files
                        </div>
                        <button class="btn btn-sm btn-outline-danger" id="clear-json-btn" disabled>
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="drop-zone mb-3" id="json-drop-zone">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <p>Drag & drop JSON files here or click the button below</p>
                            <small class="text-muted">(Files from Unity sprite atlases)</small>
                        </div>
                        <div class="file-list" id="json-file-list">
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-file-import fa-2x mb-2"></i>
                                <p>No JSON files selected</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="file" id="json-file-input" class="d-none" accept=".json" multiple>
                            <button class="btn btn-primary flex-grow-1" onclick="document.getElementById('json-file-input').click()">
                                <i class="fas fa-plus-circle"></i> Add JSON Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-image feature-icon"></i> Texture Files
                        </div>
                        <button class="btn btn-sm btn-outline-danger" id="clear-texture-btn" disabled>
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="drop-zone mb-3" id="texture-drop-zone">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <p>Drag & drop texture files here or click the button below</p>
                            <small class="text-muted">(PNG, JPG, or other image files)</small>
                        </div>
                        <div class="file-list" id="texture-file-list">
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-file-image fa-2x mb-2"></i>
                                <p>No texture files selected</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="file" id="texture-file-input" class="d-none" accept="image/*" multiple>
                            <button class="btn btn-primary flex-grow-1" onclick="document.getElementById('texture-file-input').click()">
                                <i class="fas fa-plus-circle"></i> Add Texture Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs feature-icon"></i> Processing Options
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" id="process-btn" disabled>
                                <i class="fas fa-gear"></i> Process Atlas
                            </button>
                        </div>
                        <div class="status-bar mt-3">
                            <div id="status-message">Ready to process files</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results View -->
    <div class="container" id="results-view">
        <div class="results-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-check-circle"></i> Extraction Complete!</h2>
                    <p class="mb-0" id="results-summary">0 sprites extracted</p>
                </div>
                <button class="btn btn-light" id="back-to-upload-btn">
                    <i class="fas fa-arrow-left"></i> Back to Upload
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Panel: Sprite List -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list feature-icon"></i> Extracted Sprites
                    </div>
                    <div class="card-body">
                        <!-- Search Box -->
                        <div class="search-box">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="sprite-search-input" 
                                    placeholder="Search sprites by name...">
                                <button class="btn btn-outline-secondary" id="clear-search-btn" type="button">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="mt-2 small text-muted" id="search-results-count"></div>
                        </div>
                        
                        <!-- Selection Controls -->
                        <div class="selection-controls mb-3">
                            <button class="btn btn-sm btn-outline-primary" id="results-select-all-btn">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="results-deselect-all-btn">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                            <button class="btn btn-sm btn-success" id="results-download-selected-btn" disabled>
                                <i class="fas fa-download"></i> Download (<span id="selected-count">0</span>)
                            </button>
                        </div>
                        
                        <!-- Sprite List -->
                        <div class="sprite-list-container" id="sprite-list-container">
                            <!-- Will be populated dynamically -->
                        </div>
                        
                        <div class="no-results-message d-none" id="no-search-results">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>No sprites match your search</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Preview -->
            <div class="col-lg-7">
                <div class="results-preview-container">
                    <div class="results-preview-image-container" id="results-preview-image-container">
                        <div class="zoom-controls" id="zoom-controls" style="display: none;">
                            <button class="zoom-btn" id="zoom-in-btn" title="Zoom In">+</button>
                            <div class="zoom-level" id="zoom-level">100%</div>
                            <button class="zoom-btn" id="zoom-out-btn" title="Zoom Out">−</button>
                            <button class="zoom-btn" id="zoom-reset-btn" title="Reset">⟲</button>
                        </div>
                        <div class="text-muted text-center" id="results-preview-placeholder">
                            <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                            <p>Click on a sprite to preview it here</p>
                        </div>
                        <img id="results-preview-image" class="results-preview-image d-none">
                    </div>
                    
                    <div class="results-preview-info d-none" id="results-preview-info">
                        <h4 id="results-sprite-name" class="mb-2"></h4>
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Dimensions</small>
                                <div id="results-sprite-dimensions"></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Source</small>
                                <div id="results-sprite-source" class="text-truncate" style="font-size: 0.9rem;"></div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <a id="results-sprite-download-link" class="btn btn-primary">
                                <i class="fas fa-download"></i> Download This Sprite
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Button -->
    <button class="btn btn-primary info-button" data-bs-toggle="modal" data-bs-target="#infoModal">
        <i class="fas fa-info"></i>
    </button>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Application state
        const appState = {
            jsonFiles: [],
            textureFiles: [],
            extractedSprites: [],
            currentPreviewSprite: null,
            selectedSprites: new Set()
        };

        // DOM elements - Main View
        const jsonFileInput = document.getElementById('json-file-input');
        const textureFileInput = document.getElementById('texture-file-input');
        const jsonFileList = document.getElementById('json-file-list');
        const textureFileList = document.getElementById('texture-file-list');
        const clearJsonBtn = document.getElementById('clear-json-btn');
        const clearTextureBtn = document.getElementById('clear-texture-btn');
        const processBtn = document.getElementById('process-btn');
        const jsonDropZone = document.getElementById('json-drop-zone');
        const textureDropZone = document.getElementById('texture-drop-zone');
        const statusMessage = document.getElementById('status-message');
        
        // DOM elements - Results View
        const mainView = document.getElementById('main-view');
        const resultsView = document.getElementById('results-view');
        const backToUploadBtn = document.getElementById('back-to-upload-btn');
        const resultsSummary = document.getElementById('results-summary');
        const spriteListContainer = document.getElementById('sprite-list-container');
        const spriteSearchInput = document.getElementById('sprite-search-input');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const searchResultsCount = document.getElementById('search-results-count');
        const noSearchResults = document.getElementById('no-search-results');
        const resultsPreviewImage = document.getElementById('results-preview-image');
        const resultsPreviewPlaceholder = document.getElementById('results-preview-placeholder');
        const resultsPreviewInfo = document.getElementById('results-preview-info');
        const resultsSpriteName = document.getElementById('results-sprite-name');
        const resultsSpriteDimensions = document.getElementById('results-sprite-dimensions');
        const resultsSpriteSource = document.getElementById('results-sprite-source');
        const resultsSpriteDownloadLink = document.getElementById('results-sprite-download-link');
        const resultsSelectAllBtn = document.getElementById('results-select-all-btn');
        const resultsDeselectAllBtn = document.getElementById('results-deselect-all-btn');
        const resultsDownloadSelectedBtn = document.getElementById('results-download-selected-btn');
        const selectedCountSpan = document.getElementById('selected-count');
        
        // Zoom and pan controls
        const zoomControls = document.getElementById('zoom-controls');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        const zoomLevelDisplay = document.getElementById('zoom-level');
        
        let imageZoom = 1;
        let imagePanX = 0;
        let imagePanY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        // Initialize event listeners
        function initEventListeners() {
            jsonFileInput.addEventListener('change', handleJsonFilesAdded);
            textureFileInput.addEventListener('change', handleTextureFilesAdded);
            clearJsonBtn.addEventListener('click', clearAllJsonFiles);
            clearTextureBtn.addEventListener('click', clearAllTextureFiles);
            processBtn.addEventListener('click', processAtlas);
            
            // Results view listeners
            backToUploadBtn.addEventListener('click', showMainView);
            spriteSearchInput.addEventListener('input', filterSprites);
            clearSearchBtn.addEventListener('click', clearSearch);
            resultsSelectAllBtn.addEventListener('click', selectAllSpritesInResults);
            resultsDeselectAllBtn.addEventListener('click', deselectAllSpritesInResults);
            resultsDownloadSelectedBtn.addEventListener('click', downloadSelectedSprites);
            
            // Zoom and pan controls
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            zoomResetBtn.addEventListener('click', resetZoom);
            
            // Mouse wheel zoom
            const previewContainer = document.getElementById('results-preview-image-container');
            previewContainer.addEventListener('wheel', handleWheel, { passive: false });
            
            // Pan controls
            previewContainer.addEventListener('mousedown', startDrag);
            previewContainer.addEventListener('mousemove', drag);
            previewContainer.addEventListener('mouseup', endDrag);
            previewContainer.addEventListener('mouseleave', endDrag);
            
            // Set up drag and drop
            setupDragAndDrop(jsonDropZone, handleJsonFilesAdded);
            setupDragAndDrop(textureDropZone, handleTextureFilesAdded);
        }

        // Set up drag and drop for a zone
        function setupDragAndDrop(dropZone, handler) {
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function() {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    handler({target: {files: e.dataTransfer.files}});
                }
            });
            
            dropZone.addEventListener('click', function() {
                const inputId = dropZone.id === 'json-drop-zone' ? 'json-file-input' : 'texture-file-input';
                document.getElementById(inputId).click();
            });
        }

        // Update drop zone visibility
        function updateDropZoneVisibility() {
            if (appState.jsonFiles.length > 0) {
                jsonDropZone.style.display = 'none';
            } else {
                jsonDropZone.style.display = 'block';
            }
            
            if (appState.textureFiles.length > 0) {
                textureDropZone.style.display = 'none';
            } else {
                textureDropZone.style.display = 'block';
            }
        }

        // Handle JSON files added
        function handleJsonFilesAdded(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.name.endsWith('.json') && !appState.jsonFiles.some(f => f.name === file.name)) {
                    appState.jsonFiles.push(file);
                    updateStatus(`Added JSON file: ${file.name}`);
                }
            });
            updateJsonFileList();
            updateProcessButtonState();
            updateDropZoneVisibility();
            event.target.value = '';
        }

        // Handle texture files added
        function handleTextureFilesAdded(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/') && !appState.textureFiles.some(f => f.name === file.name)) {
                    appState.textureFiles.push(file);
                    updateStatus(`Added texture file: ${file.name}`);
                }
            });
            updateTextureFileList();
            updateProcessButtonState();
            updateDropZoneVisibility();
            event.target.value = '';
        }

        // Update JSON file list UI
        function updateJsonFileList() {
            if (appState.jsonFiles.length === 0) {
                jsonFileList.innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-file-import fa-2x mb-2"></i><p>No JSON files selected</p></div>';
                clearJsonBtn.disabled = true;
                return;
            }
            
            jsonFileList.innerHTML = '';
            appState.jsonFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>${file.name}</div>
                    <div class="text-muted">${formatFileSize(file.size)}</div>
                `;
                jsonFileList.appendChild(fileItem);
            });
            
            clearJsonBtn.disabled = false;
        }

        // Update texture file list UI
        function updateTextureFileList() {
            if (appState.textureFiles.length === 0) {
                textureFileList.innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-file-image fa-2x mb-2"></i><p>No texture files selected</p></div>';
                clearTextureBtn.disabled = true;
                return;
            }
            
            textureFileList.innerHTML = '';
            appState.textureFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>${file.name}</div>
                    <div class="text-muted">${formatFileSize(file.size)}</div>
                `;
                textureFileList.appendChild(fileItem);
            });
            
            clearTextureBtn.disabled = false;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Clear all JSON files
        function clearAllJsonFiles() {
            if (appState.jsonFiles.length === 0) {
                updateStatus("No JSON files to clear.");
                return;
            }
            
            const count = appState.jsonFiles.length;
            appState.jsonFiles = [];
            
            updateJsonFileList();
            updateProcessButtonState();
            updateDropZoneVisibility();
            
            updateStatus(`Cleared ${count} JSON files.`);
        }

        // Clear all texture files
        function clearAllTextureFiles() {
            if (appState.textureFiles.length === 0) {
                updateStatus("No texture files to clear.");
                return;
            }
            
            const count = appState.textureFiles.length;
            appState.textureFiles = [];
            
            updateTextureFileList();
            updateProcessButtonState();
            updateDropZoneVisibility();
            
            updateStatus(`Cleared ${count} texture files.`);
        }

        // Update process button state
        function updateProcessButtonState() {
            processBtn.disabled = appState.jsonFiles.length === 0 || 
                                 appState.textureFiles.length === 0;
        }

        // Update status message
        function updateStatus(message) {
            statusMessage.textContent = message;
        }

        // Match JSON to texture
        function matchJsonToTexture(jsonFilename, textureFiles) {
            const jsonName = jsonFilename.replace('.json', '');
            
            for (let i = 0; i < textureFiles.length; i++) {
                const textureName = textureFiles[i].name.split('.')[0];
                if (textureName === jsonName) {
                    return textureFiles[i];
                }
            }
            
            for (let i = 0; i < textureFiles.length; i++) {
                const textureName = textureFiles[i].name.split('.')[0];
                if (textureName.includes(jsonName) || jsonName.includes(textureName)) {
                    return textureFiles[i];
                }
            }
            
            return textureFiles.length > 0 ? textureFiles[0] : null;
        }

        // Process atlas files
        async function processAtlas() {
            if (appState.jsonFiles.length === 0 || appState.textureFiles.length === 0) {
                updateStatus("Error: Please add JSON and texture files first.");
                return;
            }
            
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            updateStatus("Processing started...");
            
            try {
                appState.extractedSprites = [];
                appState.selectedSprites.clear();
                let totalExtracted = 0;
                
                for (const jsonFile of appState.jsonFiles) {
                    updateStatus(`Processing JSON: ${jsonFile.name}`);
                    
                    const jsonText = await readFileAsText(jsonFile);
                    const jsonData = JSON.parse(jsonText);
                    
                    const textureFile = matchJsonToTexture(jsonFile.name, appState.textureFiles);
                    
                    if (textureFile) {
                        updateStatus(`Matched texture: ${textureFile.name}`);
                        
                        const extracted = await extractSpritesFromAtlas(jsonData, textureFile, jsonFile.name);
                        totalExtracted += extracted;
                        
                        updateStatus(`Extracted ${extracted} sprites from ${jsonFile.name}`);
                    } else {
                        updateStatus(`No matching texture found for ${jsonFile.name}`);
                    }
                }
                
                if (totalExtracted > 0) {
                    appState.selectedSprites = new Set([...Array(totalExtracted).keys()]);
                    showResultsView();
                    updateStatus(`Processing complete! ${totalExtracted} sprites extracted and selected.`);
                } else {
                    updateStatus('No sprites were extracted. Check your files and try again.');
                }
                
            } catch (error) {
                updateStatus(`Error during processing: ${error.message}`);
                console.error(error);
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-gear"></i> Process Atlas';
            }
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        // Read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsDataURL(file);
            });
        }

        // Extract sprites from atlas
        async function extractSpritesFromAtlas(jsonData, textureFile, jsonFileName) {
            try {
                const textureDataURL = await readFileAsDataURL(textureFile);
                
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function() {
                        const atlasWidth = img.width;
                        const atlasHeight = img.height;
                        
                        updateStatus(`Atlas texture size: ${atlasWidth}x${atlasHeight}`);
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = atlasWidth;
                        canvas.height = atlasHeight;
                        ctx.drawImage(img, 0, 0);
                        
                        const spritesData = jsonData.DataArray || [];
                        let extractedCount = 0;
                        let processed = 0;
                        
                        const processNextSprite = () => {
                            if (processed >= spritesData.length) {
                                resolve(extractedCount);
                                return;
                            }
                            
                            const spriteData = spritesData[processed++];
                            setTimeout(() => processSprite(spriteData), 0);
                        };
                        
                        const processSprite = (spriteData) => {
                            const spriteName = spriteData.SpriteName || `sprite_${extractedCount}`;
                            const position = spriteData.Position || {};
                            const size = spriteData.Size || {};
                            const offset = spriteData.Offset || {};
                            const originalSize = spriteData.OriginalSize || {};
                            
                            const x = position.x || 0;
                            const y = position.y || 0;
                            const width = size.x || 0;
                            const height = size.y || 0;
                            
                            const yCorrected = atlasHeight - y - height;
                            
                            if (width > 0 && height > 0) {
                                const safeX = Math.max(0, Math.min(x, atlasWidth - 1));
                                const safeY = Math.max(0, Math.min(yCorrected, atlasHeight - 1));
                                
                                const cropRight = Math.min(safeX + width, atlasWidth);
                                const cropBottom = Math.min(safeY + height, atlasHeight);
                                
                                const actualWidth = cropRight - safeX;
                                const actualHeight = cropBottom - safeY;
                                
                                const spriteCanvas = document.createElement('canvas');
                                const spriteCtx = spriteCanvas.getContext('2d');
                                spriteCanvas.width = actualWidth;
                                spriteCanvas.height = actualHeight;
                                
                                spriteCtx.drawImage(
                                    canvas,
                                    safeX, safeY, actualWidth, actualHeight,
                                    0, 0, actualWidth, actualHeight
                                );
                                
                                if (offset.x !== undefined && offset.y !== undefined && 
                                    originalSize.x !== undefined && originalSize.y !== undefined) {
                                    const offsetX = offset.x || 0;
                                    const offsetY = offset.y || 0;
                                    const origWidth = originalSize.x || width;
                                    const origHeight = originalSize.y || height;
                                    
                                    if (origWidth > actualWidth || origHeight > actualHeight) {
                                        const paddedCanvas = document.createElement('canvas');
                                        const paddedCtx = paddedCanvas.getContext('2d');
                                        paddedCanvas.width = origWidth;
                                        paddedCanvas.height = origHeight;
                                        
                                        paddedCtx.clearRect(0, 0, origWidth, origHeight);
                                        
                                        const pasteX = offsetX;
                                        const pasteY = origHeight - offsetY - actualHeight;
                                        
                                        const safePasteX = Math.max(0, Math.min(pasteX, origWidth - actualWidth));
                                        const safePasteY = Math.max(0, Math.min(pasteY, origHeight - actualHeight));
                                        
                                        paddedCtx.drawImage(
                                            spriteCanvas,
                                            safePasteX, safePasteY
                                        );
                                        
                                        spriteCanvas.width = origWidth;
                                        spriteCanvas.height = origHeight;
                                        spriteCtx.drawImage(paddedCanvas, 0, 0);
                                        
                                        updateStatus(`Padded ${spriteName} to original size: ${origWidth}x${origHeight}`);
                                    }
                                }
                                
                                const spriteDataURL = spriteCanvas.toDataURL('image/png');
                                appState.extractedSprites.push({
                                    name: spriteName,
                                    data: spriteDataURL,
                                    width: spriteCanvas.width,
                                    height: spriteCanvas.height,
                                    source: jsonFileName
                                });
                                
                                extractedCount++;
                                updateStatus(`Extracted: ${spriteName}.png (${spriteCanvas.width}x${spriteCanvas.height})`);
                                processNextSprite();
                            } else {
                                updateStatus(`Skipping ${spriteName}: invalid size (${width}x${height})`);
                                processNextSprite();
                            }
                        };
                        
                        processNextSprite();
                    };
                    img.src = textureDataURL;
                });
                
            } catch (error) {
                updateStatus(`Error extracting sprites: ${error.message}`);
                console.error(error);
                return 0;
            }
        }

        // Results View Functions
        function showResultsView() {
            mainView.style.display = 'none';
            resultsView.style.display = 'block';
            
            resultsSummary.textContent = `${appState.extractedSprites.length} sprite${appState.extractedSprites.length !== 1 ? 's' : ''} extracted`;
            
            populateSpriteList();
            updateSelectedCount();
            
            window.scrollTo(0, 0);
        }
        
        function showMainView() {
            resultsView.style.display = 'none';
            mainView.style.display = 'block';
            
            clearSearch();
            
            window.scrollTo(0, 0);
        }
        
        function populateSpriteList() {
            if (appState.extractedSprites.length === 0) {
                spriteListContainer.innerHTML = `
                    <div class="text-muted text-center py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No sprites to display</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            appState.extractedSprites.forEach((sprite, index) => {
                const isSelected = appState.selectedSprites.has(index);
                html += `
                    <div class="sprite-list-item" data-index="${index}" data-name="${sprite.name.toLowerCase()}" 
                        onclick="previewSpriteInResults(${index})">
                        <input type="checkbox" class="form-check-input me-2" ${isSelected ? 'checked' : ''} 
                            onclick="event.stopPropagation(); toggleSpriteSelectionInResults(${index}, this.checked)">
                        <img src="${sprite.data}" class="sprite-list-thumbnail">
                        <div class="sprite-list-info">
                            <div class="sprite-list-name">${sprite.name}</div>
                            <div class="sprite-list-meta">${sprite.width} × ${sprite.height} px</div>
                        </div>
                    </div>
                `;
            });
            
            spriteListContainer.innerHTML = html;
            updateSearchResultsCount();
        }
        
        function previewSpriteInResults(index) {
            const sprite = appState.extractedSprites[index];
            if (!sprite) return;
            
            document.querySelectorAll('.sprite-list-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sprite-list-item[data-index="${index}"]`).classList.add('active');
            
            resultsPreviewImage.src = sprite.data;
            resultsPreviewImage.classList.remove('d-none');
            resultsPreviewPlaceholder.classList.add('d-none');
            resultsPreviewInfo.classList.remove('d-none');
            zoomControls.style.display = 'flex';
            
            resultsSpriteName.textContent = `${sprite.name}.png`;
            resultsSpriteDimensions.textContent = `${sprite.width} × ${sprite.height} pixels`;
            resultsSpriteSource.textContent = sprite.source;
            resultsSpriteDownloadLink.href = sprite.data;
            resultsSpriteDownloadLink.download = `${sprite.name}.png`;
            
            // Reset zoom and pan
            resetZoom();
        }
        
        function toggleSpriteSelectionInResults(index, isSelected) {
            if (isSelected) {
                appState.selectedSprites.add(index);
            } else {
                appState.selectedSprites.delete(index);
            }
            
            updateSelectedCount();
        }
        
        function selectAllSpritesInResults() {
            const visibleItems = document.querySelectorAll('.sprite-list-item:not(.hidden)');
            visibleItems.forEach(item => {
                const index = parseInt(item.dataset.index);
                appState.selectedSprites.add(index);
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
            });
            
            updateSelectedCount();
            updateStatus(`Selected ${visibleItems.length} sprite${visibleItems.length !== 1 ? 's' : ''}.`);
        }
        
        function deselectAllSpritesInResults() {
            const visibleItems = document.querySelectorAll('.sprite-list-item:not(.hidden)');
            visibleItems.forEach(item => {
                const index = parseInt(item.dataset.index);
                appState.selectedSprites.delete(index);
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            
            updateSelectedCount();
            updateStatus(`Deselected ${visibleItems.length} sprite${visibleItems.length !== 1 ? 's' : ''}.`);
        }
        
        function updateSelectedCount() {
            const count = appState.selectedSprites.size;
            selectedCountSpan.textContent = count;
            resultsDownloadSelectedBtn.disabled = count === 0;
        }
        
        function filterSprites() {
            const searchTerm = spriteSearchInput.value.toLowerCase().trim();
            const items = document.querySelectorAll('.sprite-list-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const spriteName = item.dataset.name;
                if (spriteName.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });
            
            if (visibleCount === 0 && searchTerm !== '') {
                noSearchResults.classList.remove('d-none');
                spriteListContainer.classList.add('d-none');
            } else {
                noSearchResults.classList.add('d-none');
                spriteListContainer.classList.remove('d-none');
            }
            
            updateSearchResultsCount();
        }
        
        function updateSearchResultsCount() {
            const totalCount = appState.extractedSprites.length;
            const visibleCount = document.querySelectorAll('.sprite-list-item:not(.hidden)').length;
            
            if (spriteSearchInput.value.trim() !== '') {
                searchResultsCount.textContent = `Showing ${visibleCount} of ${totalCount} sprites`;
            } else {
                searchResultsCount.textContent = `${totalCount} sprite${totalCount !== 1 ? 's' : ''} total`;
            }
        }
        
        function clearSearch() {
            spriteSearchInput.value = '';
            filterSprites();
        }

        // Zoom and Pan Functions
        function updateImageTransform() {
            resultsPreviewImage.style.transform = `translate(${imagePanX}px, ${imagePanY}px) scale(${imageZoom})`;
            zoomLevelDisplay.textContent = `${Math.round(imageZoom * 100)}%`;
        }
        
        function zoomIn() {
            imageZoom = Math.min(imageZoom + 0.25, 5);
            updateImageTransform();
        }
        
        function zoomOut() {
            imageZoom = Math.max(imageZoom - 0.25, 0.25);
            updateImageTransform();
        }
        
        function resetZoom() {
            imageZoom = 1;
            imagePanX = 0;
            imagePanY = 0;
            updateImageTransform();
        }
        
        function handleWheel(e) {
            if (resultsPreviewImage.classList.contains('d-none')) return;
            
            e.preventDefault();
            
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            imageZoom = Math.max(0.25, Math.min(5, imageZoom + delta));
            updateImageTransform();
        }
        
        function startDrag(e) {
            if (resultsPreviewImage.classList.contains('d-none')) return;
            if (imageZoom === 1) return;
            
            isDragging = true;
            dragStartX = e.clientX - imagePanX;
            dragStartY = e.clientY - imagePanY;
            e.currentTarget.classList.add('grabbing');
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            imagePanX = e.clientX - dragStartX;
            imagePanY = e.clientY - dragStartY;
            updateImageTransform();
        }
        
        function endDrag(e) {
            if (isDragging) {
                isDragging = false;
                e.currentTarget.classList.remove('grabbing');
            }
        }

        // Download selected sprites
        async function downloadSelectedSprites() {
            if (appState.selectedSprites.size === 0) {
                updateStatus("No sprites selected for download.");
                return;
            }
            
            try {
                const selectedIndices = Array.from(appState.selectedSprites);
                updateStatus(`Downloading ${selectedIndices.length} sprites...`);
                
                for (let i = 0; i < selectedIndices.length; i++) {
                    const index = selectedIndices[i];
                    const sprite = appState.extractedSprites[index];
                    
                    const link = document.createElement('a');
                    link.href = sprite.data;
                    link.download = `${sprite.name}.png`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    updateStatus(`Downloaded ${i + 1}/${selectedIndices.length}: ${sprite.name}.png`);
                    
                    if (i < selectedIndices.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                updateStatus("All selected sprites downloaded!");
                
            } catch (error) {
                updateStatus(`Error downloading files: ${error.message}`);
                console.error(error);
            }
        }

        // Initialize the application
        function init() {
            initEventListeners();
            updateStatus("Application started. Ready to process Unity sprite atlases.");
            updateDropZoneVisibility();
        }

        window.onload = init;

        // Make functions globally available
        window.previewSpriteInResults = previewSpriteInResults;
        window.toggleSpriteSelectionInResults = toggleSpriteSelectionInResults;
    </script>
</body>
</html>
